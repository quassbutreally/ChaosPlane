<Page
    x:Class="ChaosPlane.Views.FailureBrowserView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:ChaosPlane.ViewModels"
    xmlns:models="using:ChaosPlane.Models"
    xmlns:views="using:ChaosPlane.Views"
    Background="{StaticResource CpBgBrush}">

    <Page.Resources>
        <views:TierToLabelConverter       x:Key="TierToLabelConverter" />
        <views:TierToBackgroundConverter  x:Key="TierToBackgroundConverter" />
        <views:TierToForegroundConverter  x:Key="TierToForegroundConverter" />
        <views:BoolToUnsavedColorConverter x:Key="BoolToUnsavedColorConverter" />
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />   <!-- page header + toolbar -->
            <RowDefinition Height="Auto" />   <!-- filter bar -->
            <RowDefinition Height="*" />      <!-- table -->
            <RowDefinition Height="Auto" />   <!-- save bar -->
        </Grid.RowDefinitions>

        <!-- ── Page header ───────────────────────────────────────────────── -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <TextBlock Text="FAILURE BROWSER"
                           FontFamily="Consolas"
                           FontSize="{StaticResource CpFontSize2xl}"
                           FontWeight="Bold"
                           CharacterSpacing="100"
                           Foreground="{StaticResource CpAmberBrush}" />
                <TextBlock FontFamily="Consolas"
                           FontSize="{StaticResource CpFontSizeMd}"
                           Foreground="{StaticResource CpTextDimBrush}"
                           VerticalAlignment="Bottom"
                           Margin="0,0,0,5">
                    <Run Text="{x:Bind ViewModel.FilteredCount, Mode=OneWay}" />
                    <Run Text="/" />
                    <Run Text="{x:Bind ViewModel.TotalCount, Mode=OneWay}" />
                    <Run Text=" FAILURES" />
                </TextBlock>
            </StackPanel>

            <!-- Toolbar -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                <Button Content="ACCEPT ALL SUGGESTED"
                        Style="{StaticResource CpButtonStyle}"
                        Command="{x:Bind ViewModel.AcceptAllSuggestedTiersCommand}" />
                <Button Content="ENABLE ALL"
                        Style="{StaticResource CpGreenButtonStyle}"
                        Command="{x:Bind ViewModel.EnableAllCommand}" />
                <Button Content="DISABLE ALL"
                        Style="{StaticResource CpDangerButtonStyle}"
                        Command="{x:Bind ViewModel.DisableAllCommand}" />
            </StackPanel>
        </Grid>

        <!-- ── Filter bar ─────────────────────────────────────────────────── -->
        <Border Grid.Row="1"
                Style="{StaticResource CpCardStyle}"
                Padding="12,10"
                Margin="0,0,0,12">
            <StackPanel Orientation="Horizontal" Spacing="12">

                <!-- Search -->
                <TextBox Style="{StaticResource CpTextBoxStyle}"
                         PlaceholderText="Search name or description..."
                         Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Width="260" />

                <!-- Category filter -->
                <ComboBox Style="{StaticResource CpComboBoxStyle}"
                          ItemsSource="{x:Bind ViewModel.Categories}"
                          SelectedItem="{x:Bind ViewModel.SelectedCategory, Mode=TwoWay}"
                          Width="180" />

                <!-- Enabled only toggle -->
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <ToggleSwitch IsOn="{x:Bind ViewModel.ShowEnabledOnly, Mode=TwoWay}"
                                  OnContent="" OffContent=""
                                  MinWidth="0" />
                    <TextBlock Text="ENABLED ONLY"
                               Style="{StaticResource CpDimTextStyle}"
                               VerticalAlignment="Center" />
                </StackPanel>

                <Button Content="CLEAR FILTERS"
                        Style="{StaticResource CpButtonStyle}"
                        Command="{x:Bind ViewModel.ClearFiltersCommand}" />

            </StackPanel>
        </Border>

        <!-- ── Failure table ──────────────────────────────────────────────── -->
        <Border Grid.Row="2" Style="{StaticResource CpCardStyle}" Padding="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />   <!-- column headers -->
                    <RowDefinition Height="*" />      <!-- rows -->
                </Grid.RowDefinitions>

                <!-- Column headers -->
                <Border Grid.Row="0"
                        Background="{StaticResource CpPanelBrush}"
                        BorderBrush="{StaticResource CpBorderBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="16,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="36" />     <!-- enabled -->
                            <ColumnDefinition Width="2*" />      <!-- name -->
                            <ColumnDefinition Width="*" />    <!-- category -->
                            <ColumnDefinition Width="90" />    <!-- suggested tier -->
                            <ColumnDefinition Width="160" />    <!-- assigned tier -->
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="ON"
                                   Style="{StaticResource CpSectionHeaderStyle}" Margin="0" />
                        <TextBlock Grid.Column="1" Text="FAILURE NAME"
                                   Style="{StaticResource CpSectionHeaderStyle}" Margin="0" />
                        <TextBlock Grid.Column="2" Text="CATEGORY"
                                   Style="{StaticResource CpSectionHeaderStyle}" Margin="0" />
                        <TextBlock Grid.Column="3" Text="SUGGESTED"
                                   Style="{StaticResource CpSectionHeaderStyle}" Margin="0" />
                        <TextBlock Grid.Column="4" Text="ASSIGNED TIER"
                                   Style="{StaticResource CpSectionHeaderStyle}" Margin="0" />
                    </Grid>
                </Border>

                <!-- Rows -->
                <ListView Grid.Row="1"
                          ItemsSource="{x:Bind ViewModel.Rows}"
                          Background="Transparent"
                          SelectionMode="None">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Background" Value="Transparent" />
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="vm:FailureRowViewModel">
                            <Border BorderBrush="{StaticResource CpBorderBrush}"
                                    BorderThickness="0,0,0,1"
                                    Padding="16,10">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="36" />
                                        <ColumnDefinition Width="2*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="90" />
                                        <ColumnDefinition Width="160" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Enable toggle -->
                                    <CheckBox Grid.Column="0"
                                              IsChecked="{x:Bind IsEnabled, Mode=TwoWay}"
                                              VerticalAlignment="Center" />

                                    <!-- Name + description -->
                                    <StackPanel Grid.Column="1"
                                                VerticalAlignment="Center"
                                                Margin="0,0,12,0">
                                        <TextBlock Text="{x:Bind Name}"
                                                   FontFamily="Consolas"
                                                   FontSize="{StaticResource CpFontSizeSm}"
                                                   Foreground="{StaticResource CpTextBrush}"
                                                   TextWrapping="Wrap" />
                                        <TextBlock Text="{x:Bind Description}"
                                                   Style="{StaticResource CpDimTextStyle}"
                                                   TextWrapping="Wrap"
                                                   MaxLines="2"
                                                   TextTrimming="CharacterEllipsis"
                                                   Margin="0,2,0,0" />
                                    </StackPanel>

                                    <!-- Category -->
                                    <TextBlock Grid.Column="2"
                                               Text="{x:Bind Category}"
                                               Style="{StaticResource CpDimTextStyle}"
                                               VerticalAlignment="Center"
                                               TextWrapping="Wrap"
                                               MaxLines="2"
                                               TextTrimming="CharacterEllipsis"/>

                                    <!-- Suggested tier pill -->
                                    <Border Grid.Column="3"
                                            CornerRadius="2"
                                            Padding="8,3"
                                            HorizontalAlignment="Left"
                                            VerticalAlignment="Center"
                                            Background="{x:Bind SuggestedTier,
                                                Converter={StaticResource TierToBackgroundConverter}}">
                                        <TextBlock Text="{x:Bind SuggestedTier,
                                                       Converter={StaticResource TierToLabelConverter}}"
                                                   FontFamily="Consolas"
                                                   FontSize="{StaticResource CpFontSizeXs}"
                                                   Foreground="{x:Bind SuggestedTier,
                                                       Converter={StaticResource TierToForegroundConverter}}" />
                                    </Border>

                                    <!-- Assigned tier ComboBox -->
                                    <ComboBox Grid.Column="4"
                                              Style="{StaticResource CpComboBoxStyle}"
                                              ItemsSource="{x:Bind TierOptions}"
                                              SelectedItem="{x:Bind AssignedTier, Mode=TwoWay}"
                                              HorizontalAlignment="Stretch"
                                              VerticalAlignment="Center"
                                              PlaceholderText="— unassigned —" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>
        </Border>

        <!-- ── Save bar ───────────────────────────────────────────────────── -->
        <Border Grid.Row="3"
                Style="{StaticResource CpCardStyle}"
                Padding="16,12"
                Margin="0,12,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Status message -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="8"
                            VerticalAlignment="Center">
                    <TextBlock Text="●"
                               FontSize="8"
                               VerticalAlignment="Center"
                               Foreground="{x:Bind ViewModel.HasUnsavedChanges,
                                   Mode=OneWay,
                                   Converter={StaticResource BoolToUnsavedColorConverter}}" />
                    <TextBlock Text="{x:Bind ViewModel.SaveStatus, Mode=OneWay,
                                   FallbackValue='No unsaved changes'}"
                               Style="{StaticResource CpDimTextStyle}"
                               VerticalAlignment="Center" />
                </StackPanel>

                <ProgressRing Grid.Column="1"
                              IsActive="{x:Bind ViewModel.IsSaving, Mode=OneWay}"
                              Width="20" Height="20"
                              Margin="0,0,12,0" />

                <Button Grid.Column="2"
                        Content="SAVE CONFIGURATION"
                        Style="{StaticResource CpButtonStyle}"
                        IsEnabled="{x:Bind ViewModel.HasUnsavedChanges, Mode=OneWay}"
                        Command="{x:Bind ViewModel.SaveCommand}" />
            </Grid>
        </Border>

    </Grid>
</Page>
